#!/bin/bash
# Force-reload MacBook-specific modules after resume from s2idle.
#
# These drivers do not properly reinitialise hardware on wake.
# We keep them loaded during suspend so the keyboard can still
# generate wake events, then force-reload them after resume to
# reset the SPI controller, WiFi firmware, and webcam.
#
# Installed to /usr/lib/systemd/system-sleep/ by install.sh

LOG=/var/log/resume-modules.log

case "$1" in
    pre)
        echo "[$(date)] suspend: modules left loaded for wake support" >> "$LOG"
        ;;
    post)
        echo "[$(date)] resume: reloading modules..." >> "$LOG"

        # Wait for hardware (SPI controller, PCIe) to settle after resume
        sleep 2

        # Reload applespi (SPI keyboard/touchpad)
        modprobe -r applespi 2>> "$LOG" && echo "  applespi unloaded" >> "$LOG"
        sleep 1
        modprobe applespi 2>> "$LOG" && echo "  applespi loaded" >> "$LOG"

        # Reload brcmfmac (WiFi â€” needs firmware reload)
        modprobe -r brcmfmac_wcc 2>> "$LOG"
        modprobe -r brcmfmac 2>> "$LOG" && echo "  brcmfmac unloaded" >> "$LOG"
        sleep 1
        modprobe brcmfmac 2>> "$LOG" && echo "  brcmfmac loaded" >> "$LOG"

        # Reload facetimehd (webcam)
        modprobe -r facetimehd 2>> "$LOG"
        sleep 1
        modprobe facetimehd 2>> "$LOG" && echo "  facetimehd loaded" >> "$LOG"

        echo "[$(date)] resume: module reload complete" >> "$LOG"
        ;;
esac
