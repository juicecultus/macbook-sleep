#!/bin/bash
# Unload problematic modules before suspend to prevent resume hangs,
# then reload them after wake.
#
# applespi is kept loaded so keyboard/trackpad can generate wake events.
# All other Apple/out-of-tree modules are unloaded because their resume
# callbacks hang when the hardware they manage loses power during s2idle.
#
# Installed to /usr/lib/systemd/system-sleep/ by install.sh

LOG=/var/log/resume-modules.log

case "$1" in
    pre)
        echo "[$(date)] suspend: unloading modules..." >> "$LOG"

        # Unload WiFi (resume callback hangs reinitialising firmware)
        modprobe -r brcmfmac_wcc 2>> "$LOG"
        modprobe -r brcmfmac 2>> "$LOG" && echo "  brcmfmac unloaded" >> "$LOG"

        # Unload webcam
        modprobe -r facetimehd 2>> "$LOG" && echo "  facetimehd unloaded" >> "$LOG"

        # Unload acpi_call (out-of-tree, used by auto-brightness)
        modprobe -r acpi_call 2>> "$LOG" && echo "  acpi_call unloaded" >> "$LOG"

        # applespi stays loaded for keyboard/trackpad wake
        echo "[$(date)] suspend: ready" >> "$LOG"
        ;;
    post)
        echo "[$(date)] resume: reloading modules..." >> "$LOG"

        # Small delay for hardware to settle
        sleep 1

        # Reload applespi to reinitialise SPI keyboard/touchpad
        modprobe -r applespi 2>> "$LOG" && echo "  applespi unloaded" >> "$LOG"
        sleep 1
        modprobe applespi 2>> "$LOG" && echo "  applespi reloaded" >> "$LOG"

        # Reload WiFi
        modprobe brcmfmac 2>> "$LOG" && echo "  brcmfmac loaded" >> "$LOG"

        # Reload webcam
        modprobe facetimehd 2>> "$LOG" && echo "  facetimehd loaded" >> "$LOG"

        # Reload acpi_call
        modprobe acpi_call 2>> "$LOG" && echo "  acpi_call loaded" >> "$LOG"

        echo "[$(date)] resume: complete" >> "$LOG"
        ;;
esac
